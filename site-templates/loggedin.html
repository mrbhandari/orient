{% extends "base.html" %}
{% load staticfiles %}


{% block content %}
    <script type='text/javascript' src="{% static 'highcharts-4.0.4js/highcharts.js' %}"></script>
    <script type='text/javascript' src="{% static 'highslide-4.1.13/highslide/highslide-full.js' %}"></script>
    <script type='text/javascript' src="http://highcharts.com/highslide/highslide.config.js"></script>
    <link rel="stylesheet" type="text/css" href="http://highcharts.com/highslide/highslide.css"/>
  <div class="container">
  <h4>Welcome {{full_name}}!</h4>
  <p>Click <a href="/accounts/logout/">here</a> to logout.</p>
  
  <form id='update_graphs' action='/get'>
    Filter Query
    <textarea name='filter_query' id= 'filter_query'></textarea>
    Success Query
    <textarea name='success_query' id = 'success_query'></textarea>
    <button >Submit</button>
  </form>
  
  
  
  <div id = 'graphs'></div>
  
  
  </div>
    <script type='text/javascript'>
        
        $(document).ready(function() {
            (function ($) {
                $.fn.serializeFormJSON = function () {
            
                    var o = {};
                    var a = this.serializeArray();
                    $.each(a, function () {
                        if (o[this.name]) {
                            if (!o[this.name].push) {
                                o[this.name] = [o[this.name]];
                            }
                            o[this.name].push(this.value || '');
                        } else {
                            o[this.name] = this.value || '';
                        }
                    });
                    return o;
                };
            })(jQuery);
            
                $('form').submit(function (e) {
                    e.preventDefault();
                    var dataToBeSent = $(this).serializeFormJSON();
                    console.log(dataToBeSent);
                
                    $.post('get_graph_data/', dataToBeSent, function(data) {
                        //data contains the JSON object
                        //textStatus contains the status: success, error, etc
                        
                        console.log(data)
                      }, "json");
                });
            
                //$('#update_graphs').submit( function(e) {
                //    var filter_query = $("#filter_query").val()
                //    var success_query = $("#success_query").val()
                //    //alert('you clicked' + filter_query + success_query);
                //    e.preventDefault();
                //    var dataToBeSent = $("form").serialize();
                //    console.log($("form"))
                //    
                //    
                //    
                //});
            
            
            $.getJSON('/ajax/set_post_status_series', function(datacollection) {
                
                
                
                for (counter = 0; counter < datacollection.length; counter++) {
                    var data = datacollection[counter]
                    var detail_url = encodeURI(data.title.replace(/::/g, "&"))
                    $('#graphs').append(["<h3 class='container'>", data.title, "</h3>", "<a target='_blank' href='\getdetails?", detail_url, "'>Detail</a>"].join(''))
                    $('#graphs').append( "<div  id='container" + counter + "' counter='" + counter + "'></div>" )
                    console.log(data.series[6]);
                    $('#container' + counter).highcharts({
                        chart: {
                            type: 'spline'
                        },
                        title: {
                            text: '',
                            style: {
                            display: 'none'
                        }
                        },
                        counter_no: {
                            value: counter
                        },
                        xAxis: {
                            type: 'linear',
                            labels: {
                                overflow: 'justify'
                            }
                        },
                        yAxis: {
                            title: {
                                text: 'Correlation'
                            },
                            //min: 0,
                            //max: 1,
                            minorGridLineWidth: 0,
                            gridLineWidth: 0,
                            alternateGridColor: null,
                            plotBands: [{ // No correlation
                                from: 0.0,
                                to: 0.1,
                                color: 'rgba(68, 170, 213, 0.1)',
                                label: {
                                    text: 'No correlation',
                                    style: {
                                        color: '#606060'
                                    }
                                }
                            }, { // Weak
                                from: 0.1,
                                to: 0.25,
                                color: 'rgba(0, 0, 0, 0)',
                                label: {
                                    text: 'Weak',
                                    style: {
                                        color: '#606060'
                                    }
                                }
                            }, { // Strong
                                from: 0.25,
                                to: 0.5,
                                color: 'rgba(68, 170, 213, 0.1)',
                                label: {
                                    text: 'Strong',
                                    style: {
                                        color: '#606060'
                                    }
                                }
                            }, { // Very Strong
                                from: 0.5,
                                to: 1,
                                color: 'rgba(0, 0, 0, 0)',
                                label: {
                                    text: 'Very Strong',
                                    style: {
                                        color: '#606060'
                                    }
                                }
                            }]
                        },
                        tooltip: {
                            valueSuffix: ' correlation coefficient',
                            shared: true,
                            crosshairs: true,
                        },
                        plotOptions: {
                            spline: {
                                lineWidth: 4,
                                states: {
                                    hover: {
                                        lineWidth: 5
                                    }
                                },
                        allowPointSelect: true,
                                
                        point: {
                            events: {
                                click: function (e) {
                                    
                                    
                                    var target = $( e.target )
                                    var graph_no = target.parent().parent().parent().parent().parent().attr('counter')
                                    var tp = datacollection[graph_no].series[1].data[this.category][1]
                                    var fp = datacollection[graph_no].series[2].data[this.category][1]
                                    var tn = datacollection[graph_no].series[3].data[this.category][1]
                                    var fn = datacollection[graph_no].series[4].data[this.category][1]
                                    var mcc = datacollection[graph_no].series[5].data[this.category][1]
                                    var chi_squared = datacollection[graph_no].series[6].data[this.category][1]
                                    var row1 = "<table><tr><td> </td><td>+ (Predicted)</td><td>- (Predicted)</td></tr>"
                                    var row2 = "<tr><td> + (Actual)</td><td>" + tp + "</td><td>"+fn+"</td></tr>"
                                    var row3 = "<tr><td> - (Actual)</td><td>" + fp + "</td><td>"+tn+"</td></tr></table>"
                                    var row4 = "<br>Chi squared: " + chi_squared
                                    var row5 = "<br>MCC: " + mcc
                                    hs.htmlExpand(null, {
                                        headingText: 'Details',
                                        maincontentText:  row1 + row2 + row3 + row4 + row5,
                                        width: 300
                                    });
                                }
                            },
                            marker: {
                                    enabled: true
                            },
                        },
                                
                                                                
                                
                            }
                        },
                        series: [data.series[5]],
                        navigation: {
                            menuItemStyle: {
                                fontSize: '10px'
                            }
                        }
                    }); //end highcharts container
                };//end for datacollection loop
            }); //end getJSON
        }); //end document ready
    </script>




  </div>

{% endblock %}