{% extends "base.html" %}
{% load staticfiles %}


{% block content %}
    
    <!--high charts-->
    <script type='text/javascript' src="{% static 'highcharts-4.0.4js/highcharts.js' %}"></script>
    <script type='text/javascript' src="{% static 'highslide-4.1.13/highslide/highslide-full.js' %}"></script>
    
    <!--highslide-->
    <script type='text/javascript' src="http://highcharts.com/highslide/highslide.config.js"></script>
    <link rel="stylesheet" type="text/css" href="http://highcharts.com/highslide/highslide.css"/>
    
    <!--forcookie management - csrf tokesn-->
    <script src="{% static 'jquery-cookie-1.4.1/jquery.cookie.js' %}"></script>
    
    <!--bootstrap data tables-->
    <script src="{% static 'datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'datatables/dataTables.bootstrap.js' %}"></script>
    <link href="{% static 'datatables/jquery.dataTables.min.css' %}" rel="stylesheet" media="screen">
    <link href="{% static 'datatables/dataTables.bootstrap.css' %}" rel="stylesheet" media="screen">
    
    <!--scroll to top widget-->
    <script src="{% static 'Scroll-To-Top/src/jquery-scrollToTop.js' %}"></script>
    <link href="{% static 'Scroll-To-Top/css/easing.css' %}" rel="stylesheet" media="screen">
    <link href="{% static 'Scroll-To-Top/css/scrollToTop.css' %}" rel="stylesheet" media="screen">
        
    <!-- DataTables Column Filter -->
    <link href="{% static 'yadcf-master/jquery.dataTables.yadcf.css' %}" rel="stylesheet" type="text/css" />
    <script src="{% static 'yadcf-master/jquery.dataTables.yadcf.js' %}"></script>
    <!-- Sliders Jquery -->
    <link href="{% static 'jquery-ui-1.11.2/jquery-ui.css' %}" rel="stylesheet" type="text/css" />
    <script src="{% static 'jquery-ui-1.11.2/jquery-ui.js' %}"></script>


  <div class="container">

  <!--<p>Hi {{full_name}} you are now logged in! Click <a href="/accounts/logout/">here</a> to logout.</p>
  <p>Note: each user can only run one query at a time.</p>-->

  
  
    <div class="bs-example" data-example-id="basic-forms">
        <form id='update_graphs' class="form-horizontal" action='/get'>
          <div class="form-group">
            <label class="col-sm-2 control-label">Users considered</label>
            <div class="col-sm-10">
            <textarea class= 'form-control' name='filter_query' id= 'filter_query'></textarea>
            <p class="help-block">Consider a segment like all users who are new (e.g., start_hc<5).</p>
            </div>
            
          </div>
          <div class="form-group">
            <label class="col-sm-2 control-label">Success goal</label>
            <div class="col-sm-10">
            <textarea class= 'form-control' name='success_query' id = 'success_query'></textarea>
            <p class="help-block">Consider how you define successful users. We'll look at what these users did versus failures for you.</p>
            </div>
            
          </div>
          <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
                <button id="form_test" type="submit" class="btn btn-default">Test</button>
                <button id="form_submit" type="submit" class="btn btn-default">Calculate</button>
            </div>
          </div>
          
        </form>
    </div><!-- /example -->
  
    <!-- /Loading div - hidden by default -->
    <div id="loading" class="bs-callout bs-callout-info" id="callout-helper-context-color-specificity">
    <h4>Loading data ...</h4>
    <p>Thanks for your patience. We're working on improving our speed but for now we want to make sure you get the best insights.</p>
    <div class="progress"><div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 100%"><span class="sr-only">0% Complete</span></div></div>
    </div>
  
    <div id = 'status_update'></div>
    <div id = 'graph_area_title'></div>    
    <div id = 'graphs'></div>
  
  
  </div>
    <script type='text/javascript'>
        //this creates a loading modal    
        var myApp;
        myApp = myApp || (function () {
            var pleaseWaitDiv = $('#loading');
            return {
                showPleaseWait: function() {
                    console.log("wait")
                    pleaseWaitDiv.show();
                },
                hidePleaseWait: function () {
                    console.log("hide")
                    pleaseWaitDiv.hide();
                },
        
            };
        })();
        
        //converts a title url to a grph url - replaces the parameters and hashes
        function convert_title_to_url(graph_title, prepend_string) {
            detail_param = encodeURI(graph_title.replace(/&/g, "%26").replace(/::/g, "&").replace(/#/g, "%23"))
            return prepend_string + detail_param
        }

        
        $(document).ready(function() {
            $('#loading').hide()
            //this block of code allows ajax post requests to be made from the browser
            var csrftoken = $.cookie('csrftoken');
            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
            
            
            //this function translates the data in a form into a json object
            (function ($) {
                $.fn.serializeFormJSON = function () {
            
                    var o = {};
                    var a = this.serializeArray();
                    $.each(a, function () {
                        if (o[this.name]) {
                            if (!o[this.name].push) {
                                o[this.name] = [o[this.name]];
                            }
                            o[this.name].push(this.value || '');
                        } else {
                            o[this.name] = this.value || '';
                        }
                    });
                    return o;
                };
            })(jQuery);
            
            
            
            //this block tests what the user is about to submit
            $('#form_test').click(function (e) {
                e.preventDefault();
                
                //show loader and clear the last status
                myApp.showPleaseWait();
                $('#status_update').empty();
                
                var dataToBeSent = $(this).parent().parent().parent().serializeFormJSON(); //element's parent is form
                console.log(dataToBeSent);
                test_graph_refresh(dataToBeSent);

            });
            
            //this block refreshes graphs when user submits the form
            $('#form_submit').click(function (e) {
                e.preventDefault();
            
            //TODO: trace if fails  
                
                //part 1: test the queries
                myApp.showPleaseWait(); //show spinnner
                var dataToBeSent = $(this).parent().parent().parent().serializeFormJSON(); //element's parent is form
                console.log(dataToBeSent);
                //test data function to see if this is the data you want - returns a div with data
                //test_graph_refresh(dataToBeSent)
                
                //part 2: generate the data
                myApp.showPleaseWait(); //show spinnner
                //$('#graphs').empty(); //clear the last status
                
                $.post('get_graph_data/', dataToBeSent, function(data) {
                    //on success of data generation  
                    $('#graphs').append('<div class="alert alert-success" role="alert">' + data.status + '</div>' ) //updates that data was generated
                    
                    //start updating the graphs
                    execute_graph_refresh();
                    //myApp.hidePleaseWait(); //hide spinner
                    $('#graph_area_title').empty(); //clear the headings
                    $('#graphs').empty(); //clear the data for previous graphs
                    

                  }, "json").fail(function() {
                    //on failure
                    $('#status_update').empty();
                    $('#status_update').append('<div class="alert alert-danger" role="alert">' + 'Invalid query - either the syntax was wrong or no succesful users were found.' + '</div>' ) //updates that data was generated
                    myApp.hidePleaseWait();
                  });
            });
            
            
            //this loads the initial page
            execute_graph_refresh();
            var graph_param = {{graph_num}};
            console.log(graph_param)
            
            function test_graph_refresh(dataToBeSent) {
                $('#status_update').empty();
                //api to test data is called
                $.post('test_graph_data/', dataToBeSent, function(data) {
                    
                    $('#status_update').append('<div class="alert alert-info" role="alert">' + JSON.stringify(data, null, 4)+ '</div>' ) //updates that data was generated
                    myApp.hidePleaseWait();
                  }, "json").fail(function() {
                    $('#status_update').empty();
                    $('#status_update').append('<div class="alert alert-danger" role="alert">' + 'Invalid query - either the syntax was wrong or no successful users were found.' + '</div>' ) //updates that data was generated
                    myApp.hidePleaseWait();
                  });
            }
            //this function fetches the generated event files and creates them
            function execute_graph_refresh() {
                myApp.showPleaseWait();
                $.getJSON('/ajax/read_graph_data', function(datacollection) {
                    
                    //creates the title block for the graphs section
                    append_string = '<div class="bs-callout bs-callout-success" id="callout-helper-context-color-specificity">'
                    //append_string += "<h4>Users considered and goal</h4>"
                    append_string += "<h4>Users Considered</h4>"
                    append_string += "<p>" + datacollection.meta.users_considered + "</p>"
                    append_string +="<h4>Success Goal</h4>"
                    append_string += "<p>" + datacollection.meta.success_users + "</p>"
                    append_string += '</div>'
                    $('#graph_area_title').append(append_string)
                    
                    
                    //Being table creation
                    
                    //First add filter div at top
                    summary_table_cols = ['Negative Predictive Value','Significance','# People Clicked','FPV','TPV','# Users','Scaled_MCC','Precision','MCC','Lift','Recall','i','F1','Leverage','Cost','TNV']
                    
                    filter_area = '<div class="bs-callout bs-callout-success"><h4>Table Filters</h4><div class="container"><div class="form-group form-inline">'

                    //loop through a create a label and div with id of the filter container area for all containers
                    for (var i=0; i < summary_table_cols.length; i++) {
                        filter_area += '<div class="col-sm-3 container">'
                        filter_area += '<label class="control-label">'+summary_table_cols[i]+'</label>' //class="control-label"
                        filter_area += '<div id="' + summary_table_cols[i].replace(/ /g,'').replace(/#/g,'') + '_filter_container' + '"></div>'
                        console.log(summary_table_cols[i].replace(/ /g,'').replace(/#/g,'') + '_filter_container')
                        filter_area += '</div>'
                    };
                    
                    filter_area += '</div></div></div>'
                    $('#graphs').append(filter_area)
                    
                    //add jquery table
                    table_json = JSON.parse(datacollection.table_json)
                    table_html = '<table id="summary_table" class="table table-striped table-bordered" cellspacing="0" width="100%">' +
                        '<thead>'+
                        '<tr>'+
                            '<th>Event</th>'+
                            '<th>Negative Predictive Value</th>'+
                            '<th>Significance</th>'+
                            '<th># People Clicked</th>'+
                            '<th>FPV</th>'+
                            '<th>TPV</th>'+
                            '<th># Users</th>'+
                            '<th>Scaled_MCC</th>'+
                            '<th>Precision</th>'+
                            '<th>MCC</th>'+
                            '<th>Lift</th>'+
                            '<th>Recall</th>'+
                            '<th>i</th>'+
                            '<th>F1</th>'+
                            '<th>Leverage</th>'+
                            '<th>Cost</th>'+
                            '<th>TNV</th>'+
                        '</tr>'+
                    '</thead>'+
                    '</table>'
        
                    $('#graphs').append(table_html)
                        var tr;
                        var cnta = 1
                        for (var key in table_json) {
                            
                            tr = $('<tr/>'); //#summary_table tbody tr
                            tr.append("<td><a href='#" + cnta.toString() +"'>" + table_json[key].event + "</a></td>");
                            tr.append("<td>" + parseFloat(table_json[key].negative_predictive_value).toFixed(2) + "</td>");
                            tr.append("<td>" + parseFloat(table_json[key].significance).toFixed(2) + "</td>");
                            tr.append("<td>" + table_json[key].num_people_clicked + "</td>");
                            tr.append("<td>" + table_json[key].fpv + "</td>");
                            tr.append("<td>" + table_json[key].tpv + "</td>");
                            tr.append("<td>" + table_json[key].num_users + "</td>");
                            tr.append("<td>" + parseFloat(table_json[key].scaled_mcc).toFixed(2) + "</td>");
                            tr.append("<td>" + parseFloat(table_json[key].precision).toFixed(2) + "</td>");
                            tr.append("<td>" + parseFloat(table_json[key].mcc).toFixed(2) + "</td>");
                            tr.append("<td>" + parseFloat(table_json[key].lift).toFixed(2) + "</td>");
                            tr.append("<td>" + parseFloat(table_json[key].recall).toFixed(2) + "</td>");
                            tr.append("<td>" + table_json[key].i + "</td>");
                            tr.append("<td>" + parseFloat(table_json[key].f1).toFixed(2) + "</td>");
                            tr.append("<td>" + parseFloat(table_json[key].leverage).toFixed(2) + "</td>");
                            tr.append("<td>" + table_json[key].cost + "</td>");
                            tr.append("<td>" + table_json[key].tnv + "</td>");
                            cnta = cnta+1
                            $('#summary_table').append(tr);
                    }
                    
                     var sum_table = $('#summary_table').dataTable({
                        "order": [[ 7, "desc" ]],
                        });
                    
                    //create dynamic filters
                    sum_table.yadcf([
                        //{column_number : 0  ,  filter_type: "auto_complete", filter_container_id: "Event_filter_container", filter_match_mode: "contains"},
                        {column_number : 1  ,  filter_type: "range_number_slider", filter_container_id: "NegativePredictiveValue_filter_container"},
                        {column_number : 2  ,  filter_type: "range_number_slider", filter_container_id: "Significance_filter_container"},
                        {column_number : 3  ,  filter_type: "range_number_slider", filter_container_id: "PeopleClicked_filter_container"},
                        {column_number : 4  ,  filter_type: "range_number_slider", filter_container_id: "FPV_filter_container"},
                        {column_number : 5  ,  filter_type: "range_number_slider", filter_container_id: "TPV_filter_container"},
                        {column_number : 6  ,  filter_type: "range_number_slider", filter_container_id: "Users_filter_container"},
                        {column_number : 7  ,  filter_type: "range_number_slider", filter_container_id: "Scaled_MCC_filter_container"},
                        {column_number : 8  ,  filter_type: "range_number_slider", filter_container_id: "Precision_filter_container"},
                        {column_number : 9  ,  filter_type: "range_number_slider", filter_container_id: "MCC_filter_container"},
                        {column_number : 10  ,  filter_type: "range_number_slider", filter_container_id: "Lift_filter_container"},
                        {column_number : 11  ,  filter_type: "range_number_slider", filter_container_id: "Recall_filter_container"},
                        {column_number : 12 ,  filter_type: "range_number_slider", filter_container_id: "i_filter_container"},
                        {column_number : 13 ,  filter_type: "range_number_slider", filter_container_id: "F1_filter_container"},
                        {column_number : 14 ,  filter_type: "range_number_slider", filter_container_id: "Leverage_filter_container"},
                        {column_number : 15  ,  filter_type: "range_number_slider", filter_container_id: "Cost_filter_container"},
                        {column_number : 16  ,  filter_type: "range_number_slider", filter_container_id: "TNV_filter_container"},
                        //{column_number : 2, data: ["Yes", "No"], filter_default_label: "Select Yes/No"},
                        //{column_number : 3, text_data_delimiter: ",", filter_type: "auto_complete"},
                        //{column_number : 4, column_data_type: "html", html_data_type: "text", filter_default_label: "Select tag"}
                    ]);


                    //create the graphs
                    for (counter = 0; counter < datacollection.each_graph.length; counter++) {
                        
                        var data = datacollection.each_graph[counter]
                        var event_detail_url = convert_title_to_url(data.title, '\get_event_details?')
                        var user_detail_url = convert_title_to_url(data.title, '\get_user_details?')
                        $('#graphs').append(["<h4 id="+ (counter+1) +" class='container'>", (counter+1), " ", data.title, "</h4>",
                                             "<a target='_blank' href='",
                                             event_detail_url,
                                             "'>Event Details</a>",
                                             "    <a target='_blank' href='",
                                             user_detail_url,
                                             "'>User ID List</a>",].join(''))
                        $('#graphs').append( "<div  id='container" + counter + "' counter='" + counter + "'></div>" )
                        //console.log(data.series[6]);
                        $('#container' + counter).highcharts({
                            chart: {
                                type: 'spline'
                            },
                            title: {
                                text: '',
                                style: {
                                display: 'none'
                            }
                            },
                            counter_no: {
                                value: counter
                            },
                            xAxis: {
                                type: 'linear',
                                labels: {
                                    overflow: 'justify'
                                }
                            },
                            yAxis: {
                                title: {
                                    text: data.series[graph_param].name
                                },
                                //min: 0,
                                //max: 1,
                                minorGridLineWidth: 0,
                                gridLineWidth: 0,
                                alternateGridColor: null,
                                plotBands: [{ // No correlation
                                    from: 0.0,
                                    to: 0.1,
                                    color: 'rgba(68, 170, 213, 0.1)',
                                    label: {
                                        text: 'No correlation',
                                        style: {
                                            color: '#606060'
                                        }
                                    }
                                }, { // Weak
                                    from: 0.1,
                                    to: 0.25,
                                    color: 'rgba(0, 0, 0, 0)',
                                    label: {
                                        text: 'Weak',
                                        style: {
                                            color: '#606060'
                                        }
                                    }
                                }, { // Strong
                                    from: 0.25,
                                    to: 0.5,
                                    color: 'rgba(68, 170, 213, 0.1)',
                                    label: {
                                        text: 'Strong',
                                        style: {
                                            color: '#606060'
                                        }
                                    }
                                }, { // Very Strong
                                    from: 0.5,
                                    to: 1,
                                    color: 'rgba(0, 0, 0, 0)',
                                    label: {
                                        text: 'Very Strong',
                                        style: {
                                            color: '#606060'
                                        }
                                    }
                                }]
                            },
                            tooltip: {
                                //valueSuffix: '',
                                shared: true,
                                crosshairs: true,
                            },
                            plotOptions: {
                                spline: {
                                    lineWidth: 4,
                                    states: {
                                        hover: {
                                            lineWidth: 5
                                        }
                                    },
                            allowPointSelect: true,
                                    
                            point: {
                                events: {
                                    click: function (e) {
                                        
                                        
                                        var target = $( e.target )
                                        var graph_no = target.parent().parent().parent().parent().parent().attr('counter')
                                        graph_title  = datacollection.each_graph[graph_no].title
                                        var tp_detail_url = convert_title_to_url(graph_title, '\get_user_quad_details?quadrant=tp&cnt=' + this.category.toString() + '&')
                                        var fp_detail_url = convert_title_to_url(graph_title, '\get_user_quad_details?quadrant=fp&cnt=' + this.category.toString() + '&')
                                        var tn_detail_url = convert_title_to_url(graph_title, '\get_user_quad_details?quadrant=tn&cnt=' + this.category.toString() + '&')
                                        var fn_detail_url = convert_title_to_url(graph_title, '\get_user_quad_details?quadrant=fn&cnt=' + this.category.toString() + '&')
                                        
                                        
                                        console.log("graph name:", graph_title)
                                        console.log(datacollection.each_graph[graph_no].series)
                                        console.log(datacollection.each_graph[graph_no].series[5].data[this.category][1])
                                        var tp = datacollection.each_graph[graph_no].series[1].data[this.category][1]
                                        var fp = datacollection.each_graph[graph_no].series[2].data[this.category][1]
                                        var tn = datacollection.each_graph[graph_no].series[3].data[this.category][1]
                                        var fn = datacollection.each_graph[graph_no].series[4].data[this.category][1]
                                        var mcc = datacollection.each_graph[graph_no].series[5].data[this.category][1]
                                        console.log(datacollection.each_graph[graph_no].series[5].data[this.category][1])
                                        var chi_squared = datacollection.each_graph[graph_no].series[6].data[this.category][1]
                                        var scaled_mcc = mcc *(tp + fp)
                                        var expected_value = 10* tp + -1*fp
                                        var row1 = "<table class='table'><tr><th> </th><th>+ (Did event "+this.category+"+ times)</th><th>- (Didn't do event "+this.category+"+ times)</th></tr>"
                                        var row2 = "<tr><th scope='row'>Y goal</th><td class='success'><a target='_blank' href='" + tp_detail_url + "'>" + tp + "</a></td><td class='danger'><a target='_blank' href='" + fn_detail_url + "'>" + fn + "</a></td></tr>"
                                        var row3 = "<tr><th>N goal</th><td class='danger'><a target='_blank' href='" + fp_detail_url + "'>" + fp + "</a></td><td class='success'><a target='_blank' href='" + tn_detail_url + "'>" + tn + "</a></td></tr></table>"
                                        var row4 = "<br>Chi squared: " + chi_squared
                                        var row5 = "<br>MCC: " + mcc
                                        var row6 = "<br>Expected value: " + expected_value
                                        var row7 = "<br>Scaled MCC: " + scaled_mcc
                                        hs.htmlExpand(null, {
                                            headingText: 'Details',
                                            maincontentText:  row1 + row2 + row3 + row4 + row5 + row6 + row7,
                                            width: 300
                                        });
                                    }
                                },
                                marker: {
                                        enabled: true
                                },
                            },
                                    
                                                                    
                                    
                                }
                            },
                            series: [data.series[graph_param]],
                            navigation: {
                                menuItemStyle: {
                                    fontSize: '10px'
                                }
                            }
                        }); //end highcharts container
                    };//end for datacollection loop
                myApp.hidePleaseWait();
                }); //end getJSON
            } //end function for make data refresh
        
        $('body').scrollToTop({skin: 'cycle'});
        
        }); //end document ready
    </script>




  </div>

{% endblock %}