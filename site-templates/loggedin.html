{% extends "base.html" %}
{% load staticfiles %}


{% block content %}
    <script type='text/javascript' src="{% static 'highcharts-4.0.4js/highcharts.js' %}"></script>
    <script type='text/javascript' src="{% static 'highslide-4.1.13/highslide/highslide-full.js' %}"></script>
    <script type='text/javascript' src="http://highcharts.com/highslide/highslide.config.js"></script>
    <link rel="stylesheet" type="text/css" href="http://highcharts.com/highslide/highslide.css"/>
    <script src="{% static 'jquery-cookie-1.4.1/jquery.cookie.js' %}"></script>
  <div class="container">

  <p>Hi {{full_name}} you are now logged in! Click <a href="/accounts/logout/">here</a> to logout.</p>
  
<!--  <form action="/accounts/profile/" method="post"><input type='hidden' name='csrfmiddlewaretoken' value='aNJgmLAQiAAp7vXeBn1q5GKk1fxQXYfg' />
            <table class="table table-bordered table-condensed table-hover table-striped">
            <tr><th><label>Filter Query</label></th><td><textarea name='filter_query' id= 'filter_query'></textarea></td></tr>
<tr><th><label>Success Query</label></th><td><textarea name='success_query' id = 'success_query'></textarea></td></tr>
            </table>
            <input type="submit" value="Update"/>
            
        </form>
-->
    <div class="form-group">
        <form id='update_graphs' action='/get'>
                <table class="table table-bordered table-condensed table-hover table-striped">
                <tr><th><label>Users considered</label></th><td><textarea class= 'form-control' name='filter_query' id= 'filter_query'></textarea></td></tr>
                <tr><th><label>Success goal</label></th><td><textarea class= 'form-control' name='success_query' id = 'success_query'></textarea></td></tr>
                </table>
        <button class="btn btn-primary">Test</button>
        <button type="submit" class="btn btn-primary">Submit</button>
        
        </form>
    </div>
  
  {{ requestdict }}
  <div id = 'graphs'></div>
  
  
  </div>
    <script type='text/javascript'>

        function convert_title_to_url(graph_title, prepend_string) {
            detail_param = encodeURI(graph_title.replace(/::/g, "&").replace(/#/g, "%23"))
            return prepend_string + detail_param
        }

        
        $(document).ready(function() {
            //this block of code allows ajax post requests to be made from the browser
            var csrftoken = $.cookie('csrftoken');
            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
            
            
            //this function translates the data in a form into a json object
            (function ($) {
                $.fn.serializeFormJSON = function () {
            
                    var o = {};
                    var a = this.serializeArray();
                    $.each(a, function () {
                        if (o[this.name]) {
                            if (!o[this.name].push) {
                                o[this.name] = [o[this.name]];
                            }
                            o[this.name].push(this.value || '');
                        } else {
                            o[this.name] = this.value || '';
                        }
                    });
                    return o;
                };
            })(jQuery);
            
            //this block refreshes graphs when user submits the form
            $('form').submit(function (e) {
                e.preventDefault();
                var dataToBeSent = $(this).serializeFormJSON();
                console.log(dataToBeSent);
                
                //api to generate data is called
                $.post('get_graph_data/', dataToBeSent, function(data) {
                    $('#graphs').empty();
                    $('#graphs').append(data.status) //updates that data was generated
                    execute_graph_refresh();
                  }, "json");
            });
            
            
            //this loads the initial page
            execute_graph_refresh();
            var graph_param = {{graph_num}};
            console.log(graph_param)
            
            
            //this function fetches the generated event files and creates them
            function execute_graph_refresh() {
                
                $.getJSON('/ajax/set_post_status_series', function(datacollection) {
                    
                    $('#graphs').append("<h3>Users Considered:  " + datacollection.meta.users_considered + "</h3>")
                    $('#graphs').append("<h3>Success Goal:  " + datacollection.meta.success_users + "</h3><br><br>")
                    
    
                    for (counter = 0; counter < datacollection.each_graph.length; counter++) {
                        var data = datacollection.each_graph[counter]
                        var event_detail_url = convert_title_to_url(data.title, '\get_event_details?')
                        var user_detail_url = convert_title_to_url(data.title, '\get_user_details?')
                        $('#graphs').append(["<h3 class='container'>", (counter+1), " ", data.title, "</h3>",
                                             "<a target='_blank' href='",
                                             event_detail_url,
                                             "'>Event Details</a>",
                                             "    <a target='_blank' href='",
                                             user_detail_url,
                                             "'>User ID List</a>",].join(''))
                        $('#graphs').append( "<div  id='container" + counter + "' counter='" + counter + "'></div>" )
                        //console.log(data.series[6]);
                        $('#container' + counter).highcharts({
                            chart: {
                                type: 'spline'
                            },
                            title: {
                                text: '',
                                style: {
                                display: 'none'
                            }
                            },
                            counter_no: {
                                value: counter
                            },
                            xAxis: {
                                type: 'linear',
                                labels: {
                                    overflow: 'justify'
                                }
                            },
                            yAxis: {
                                title: {
                                    text: data.series[graph_param].name
                                },
                                //min: 0,
                                //max: 1,
                                minorGridLineWidth: 0,
                                gridLineWidth: 0,
                                alternateGridColor: null,
                                plotBands: [{ // No correlation
                                    from: 0.0,
                                    to: 0.1,
                                    color: 'rgba(68, 170, 213, 0.1)',
                                    label: {
                                        text: 'No correlation',
                                        style: {
                                            color: '#606060'
                                        }
                                    }
                                }, { // Weak
                                    from: 0.1,
                                    to: 0.25,
                                    color: 'rgba(0, 0, 0, 0)',
                                    label: {
                                        text: 'Weak',
                                        style: {
                                            color: '#606060'
                                        }
                                    }
                                }, { // Strong
                                    from: 0.25,
                                    to: 0.5,
                                    color: 'rgba(68, 170, 213, 0.1)',
                                    label: {
                                        text: 'Strong',
                                        style: {
                                            color: '#606060'
                                        }
                                    }
                                }, { // Very Strong
                                    from: 0.5,
                                    to: 1,
                                    color: 'rgba(0, 0, 0, 0)',
                                    label: {
                                        text: 'Very Strong',
                                        style: {
                                            color: '#606060'
                                        }
                                    }
                                }]
                            },
                            tooltip: {
                                //valueSuffix: '',
                                shared: true,
                                crosshairs: true,
                            },
                            plotOptions: {
                                spline: {
                                    lineWidth: 4,
                                    states: {
                                        hover: {
                                            lineWidth: 5
                                        }
                                    },
                            allowPointSelect: true,
                                    
                            point: {
                                events: {
                                    click: function (e) {
                                        
                                        
                                        var target = $( e.target )
                                        var graph_no = target.parent().parent().parent().parent().parent().attr('counter')
                                        graph_title  = datacollection.each_graph[graph_no].title
                                        var tp_detail_url = convert_title_to_url(graph_title, '\get_user_quad_details?quadrant=tp&cnt=' + this.category.toString() + '&')
                                        var fp_detail_url = convert_title_to_url(graph_title, '\get_user_quad_details?quadrant=fp&cnt=' + this.category.toString() + '&')
                                        var tn_detail_url = convert_title_to_url(graph_title, '\get_user_quad_details?quadrant=tn&cnt=' + this.category.toString() + '&')
                                        var fn_detail_url = convert_title_to_url(graph_title, '\get_user_quad_details?quadrant=fn&cnt=' + this.category.toString() + '&')
                                        
                                        
                                        console.log("graph name:", graph_title)
                                        console.log(datacollection.each_graph[graph_no].series)
                                        console.log(datacollection.each_graph[graph_no].series[5].data[this.category][1])
                                        var tp = datacollection.each_graph[graph_no].series[1].data[this.category][1]
                                        var fp = datacollection.each_graph[graph_no].series[2].data[this.category][1]
                                        var tn = datacollection.each_graph[graph_no].series[3].data[this.category][1]
                                        var fn = datacollection.each_graph[graph_no].series[4].data[this.category][1]
                                        var mcc = datacollection.each_graph[graph_no].series[5].data[this.category][1]
                                        console.log(datacollection.each_graph[graph_no].series[5].data[this.category][1])
                                        var chi_squared = datacollection.each_graph[graph_no].series[6].data[this.category][1]
                                        var scaled_mcc = mcc *(tp + fp)
                                        var expected_value = 10* tp + -1*fp
                                        var row1 = "<table><tr><td> </td><td>+ (Predicted)</td><td>- (Predicted)</td></tr>"
                                        var row2 = "<tr><td> + (Actual)</td><td><a target='_blank' href='" + tp_detail_url + "'>" + tp + "</a></td><td><a target='_blank' href='" + fn_detail_url + "'>" + fn + "</a></td></tr>"
                                        var row3 = "<tr><td> - (Actual)</td><td><a target='_blank' href='" + fp_detail_url + "'>" + fp + "</a></td><td><a target='_blank' href='" + tn_detail_url + "'>" + tn + "</a></td></tr></table>"
                                        var row4 = "<br>Chi squared: " + chi_squared
                                        var row5 = "<br>MCC: " + mcc
                                        var row6 = "<br>Expected value: " + expected_value
                                        var row7 = "<br>Scaled MCC: " + scaled_mcc
                                        hs.htmlExpand(null, {
                                            headingText: 'Details',
                                            maincontentText:  row1 + row2 + row3 + row4 + row5 + row6 + row7,
                                            width: 300
                                        });
                                    }
                                },
                                marker: {
                                        enabled: true
                                },
                            },
                                    
                                                                    
                                    
                                }
                            },
                            series: [data.series[graph_param]],
                            navigation: {
                                menuItemStyle: {
                                    fontSize: '10px'
                                }
                            }
                        }); //end highcharts container
                    };//end for datacollection loop
                }); //end getJSON
            } //end function for make data refresh
            
        }); //end document ready
    </script>




  </div>

{% endblock %}